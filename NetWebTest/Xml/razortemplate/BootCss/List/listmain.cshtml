@inherits YJC.Toolkit.Razor.NormalListTemplate
@using System.Data;
@using System.Web;
@using YJC.Toolkit.Data;
@using YJC.Toolkit.MetaData;
@using YJC.Toolkit.Razor;
@using YJC.Toolkit.Sys;
@using YJC.Toolkit.Web;
@{
    DataSet dataSet = (DataSet)Model;
    DataRow countRow = dataSet.GetRow("Count");
    string tableName = ViewBag.MetaData.Table.TableName;
    DataTable dataTable = dataSet.Tables[tableName];
    string url = dataSet.GetFieldValue<string>("URL", "DSelfURL");
    string condition = HttpUtility.UrlEncode(dataSet.GetFieldValue<string>("Sort", "SqlCon"));
    IEnumerable<IFieldInfoEx> fields = ViewBag.MetaData.Table.TableList;
    NormalListData pageData = (NormalListData)ViewBag.PageData;
    DataRow sortRow = dataSet.GetRow("Sort");
    FieldListOrder orderInfo = FieldListOrder.FromJson(sortRow.GetString("JsonOrder"));
    //int sortField = sortRow.GetValue<int>("SortField");
    IFieldValueProvider provider = null;
}
@functions {
    string OperatorWidth(int width)
    {
        if (width > 0)
            return "width=\"" + width + "\"";
        return string.Empty;
    }

    string CreateColAttrs(IFieldInfoEx field, FieldListOrder orderInfo)
    {
        Tk5FieldInfoEx tk5Field = field.Convert<Tk5FieldInfoEx>();
        HtmlAttributeBuilder builder = new HtmlAttributeBuilder();
        if (tk5Field.ListDetail != null && tk5Field.ListDetail.ListWidth > 0)
            builder.Add("width", tk5Field.ListDetail.ListWidth);
        if (orderInfo.Contains(field.NickName))
            builder.Add((HtmlAttribute)"selected");
        return builder.CreateAttribute();
    }

    string CreateHeadAttrs(IFieldInfoEx field, FieldListOrder orderInfo)
    {
        HtmlAttributeBuilder builder = new HtmlAttributeBuilder();
        Tk5FieldInfoEx tk5Field = field.Convert<Tk5FieldInfoEx>();
        Alignment titleAlign = tk5Field.Extension != null ? tk5Field.Extension.TitleAlign : Alignment.Left;
        if (tk5Field.DataType == TkDataType.Text || (tk5Field.ListDetail != null && tk5Field.ListDetail.TextHead))
        {
            builder.Add("class", HtmlUtil.MergeClass("text-nowrap", titleAlign.AlginClass()));
        }
        else
        {
            //builder.Add("data-sort", index.ToString());
            string order = "ASC";
            string sortClass = string.Empty;
            //if (index == sortField)
            //{
            //    order = order == "DESC" ? "ASC" : "DESC";
            //    sortClass = "sort-" + order;
            //}
            if (orderInfo.Contains(field.NickName))
            {
                var fieldOrder = orderInfo.FieldList[field.NickName];
                order = fieldOrder.Order == DbOrder.Desc ? "ASC" : "DESC";
                sortClass = "sort-" + order;
            }
            builder.Add("data-order", order);
            builder.Add("class", HtmlCommonUtil.MergeClass("text-nowrap", sortClass.ToLower(), titleAlign.AlginClass()));
            builder.Add("data-name", field.NickName);
        }

        return builder.CreateAttribute();
    }

    string CreateRowOperators(DataSet dataSet, DataRow row, IFieldValueProvider provider, NormalListData pageData)
    {
        string rowOper = RenderRowOperator(provider);
        if (rowOper == null)
        {
            rowOper = BootcssUtil.CreateRowOperators(dataSet, row, pageData.RowOperatorStyle);
            return "<td class=\"text-nowrap text-center\">" + rowOper + "</td>";
        }
        return "";
    }
}
@section DefaultListHeader {
    <tr>
        @if (pageData.OperatorPosition == OperatorPosition.Left)
        {
            <th class="text-center text-nowrap">
                <div>@pageData.OperationCaption</div>
            </th>
        }
        @foreach (IFieldInfoEx field in fields)
        {
            string title = field.DisplayName;
            if (pageData.ShowHintInHead)
            {
                Tk5FieldInfoEx tk5Field = field as Tk5FieldInfoEx;
                if (tk5Field != null && !string.IsNullOrEmpty(tk5Field.Hint))
                {
                    title += "(" + tk5Field.Hint + ")";
                }
            }
            <th @CreateHeadAttrs(field, orderInfo)>
                <div>@title</div>
            </th>
        }
        @if (pageData.OperatorPosition == OperatorPosition.Right)
        {
            <th class="text-center text-nowrap">
                <div>@pageData.OperationCaption</div>
            </th>
        }
    </tr>
}
@section DefaultListWidth {
    @if (pageData.OperatorPosition == OperatorPosition.Left)
    {
        <col @OperatorWidth(pageData.OperatorWidth) />
    }
    @foreach (IFieldInfoEx field in fields)
    {
        <col @CreateColAttrs(field, orderInfo) />
    }
    @if (pageData.OperatorPosition == OperatorPosition.Right)
    {
        <col @OperatorWidth(pageData.OperatorWidth) />
    }
}
@section DefaultTabSheet {
    @if (BootcssUtil.HasTabSheet(dataSet))
    {
        <ul class="@HtmlUtil.MergeClass("nav", BootcssUtil.GetTabClass(pageData.TabDisplayType))" role="tablist">
            @BootcssUtil.CreateTabSheets(dataSet)
        </ul>
    }
}
@RenderSectionOrDefault("TabSheet", "DefaultTabSheet")
<table class="@HtmlUtil.MergeClass("list-table table", pageData.Display.TableDisplayClass())">
    <colgroup>
        @RenderSectionOrDefault("ListWidth", "DefaultListWidth")
    </colgroup>
    @if (pageData.ShowListHeader)
    {
        <thead>
            @RenderSectionOrDefault("ListHeader", "DefaultListHeader")
        </thead>
    }
    <tbody id="pageList" data-totalcount="@countRow.GetString("TotalCount")" data-totalpage="@countRow.GetString("TotalPage")" data-page="@countRow.GetString("CurrentPage")" data-url="@url" data-condition="@condition" data-tab="@HtmlUtil.GetSelectedTab(dataSet)" data-source="@(dataSet.GetFieldValue<string>("Info", "Source"))" data-jsonorder="@StringUtil.EscapeHtmlAttribute(sortRow.GetString("JsonOrder"))">
        @if (dataTable != null)
        {
            @foreach (DataRow row in dataTable.Rows)
            {
                @{
                string rowString = @RenderRow(row);
                }
                if (rowString != null)
                {
                    @rowString
                }
                else
                {
                    @{
                    provider = CreateProvider(row, dataSet);
                    }
                    <tr>
                        @if (pageData.OperatorPosition == OperatorPosition.Left)
                        {
                            @CreateRowOperators(dataSet, row, provider, pageData);
                        }
                        @foreach (IFieldInfoEx field in fields)
                        {
                            @{
                            Tk5FieldInfoEx fieldInfo = field.Convert<Tk5FieldInfoEx>();
                            string fieldString = RenderFieldItem(row, fieldInfo);
                            }
                            if (fieldString == null)
                            {
                                @{
                                string alignClass = string.Empty;
                                Alignment align = Alignment.Left;
                                if (fieldInfo.Extension != null)
                                    align = fieldInfo.Extension.Align;
                                alignClass = align.AlginClass();
                                }
                                <td class="@alignClass">@fieldInfo.DisplayValue(provider)</td>
                            }
                            else
                            {
                                @fieldString
                            }
                        }
                        @if (pageData.OperatorPosition == OperatorPosition.Right)
                        {
                            @CreateRowOperators(dataSet, row, provider, pageData);
                        }
                    </tr>
                }
            }
        }
    </tbody>
</table>
@if (countRow.GetValue<int>("TotalCount") == 0)
{
    <div class="p30">@pageData.NoDataCaption</div>
}
else
{
    @if (@pageData.ShowPage)
    {
        @RenderLayoutPartial("pagenumber.cshtml", Model)
    }
}